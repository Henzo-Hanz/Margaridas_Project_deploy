<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Margarida's Garden & Treasury - SPA</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    /* --- CSS completo do projeto --- */
    :root {
      --sky-blue: #F0F9FC;
      --sky-light: #E0F2F7;
      --grass-green: #5FDD4D;
      --grass-dark: #4BA639;
      --flower-pink: #ff54a9;
      --flower-yellow: #FFD700;
      --flower-purple: #9966CC;
      --flower-rose: #fd0389;
      --flower-peach: #fd6b36;
      --flower-lavender: #875dd4;
      --text-dark: #4a4a4a;
      --shadow: rgba(0, 0, 0, 0.08);
      --outline: rgba(0, 0, 0, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Georgia', serif;
      overflow-x: hidden;
      min-height: 100vh;
      background: linear-gradient(180deg, var(--sky-blue) 0%, var(--sky-light) 60%, #D8F0D0 90%, var(--grass-green) 100%);
    }
    .spa-page { display: none; }
    .spa-page:not(.hidden) { display: block; }
    /* ... (restante do CSS copiado dos templates, garden, dashboard, login, treasury, modais, cards, grids, etc.) ... */
    /* ... (copie todo o style.css original aqui) ... */
  </style>
</head>
<body>
  <div id="spa-root">
    <!-- ... (HTML igual ao arquivo margarida_spa_completo.html) ... -->
    <!-- ... (login, dashboard, garden, treasury, modais, forms, charts) ... -->
  </div>
  <script>
    // --- JS completo ---
    // SPA navigation
    function spaGo(page){
      document.querySelectorAll('.spa-page').forEach(p=>p.classList.add('hidden'));
      document.getElementById('page-'+page).classList.remove('hidden');
    }
    function spaLogout(){ spaGo('login'); }

    // --- Login demo ---
    document.getElementById('login-form').addEventListener('submit', function(e){
      e.preventDefault();
      spaGo('dashboard');
    });

    // --- Garden (Senhas) ---
    let credentials = JSON.parse(localStorage.getItem('margarida_credentials')||'[]');
    function renderCredentials(){
      const listEl = document.getElementById('credentials-list');
      const emptyMsg = document.getElementById('empty-msg');
      listEl.innerHTML = '';
      if (!credentials.length) { emptyMsg.classList.remove('hidden'); return; }
      emptyMsg.classList.add('hidden');
      credentials.forEach((c,i)=>{
        const card = document.createElement('div');
        card.className = 'credential-card';
        card.innerHTML = `<div class="credential-info"><h3>${escapeHtml(c.service_name)}</h3>${c.username ? `<span class="username">${escapeHtml(c.username)}</span>` : ''}<div><code class="pwd-display">${c.password}</code></div></div><div class="credential-actions"><button class="btn-small btn-edit" data-id="${i}">Editar</button><button class="btn-small btn-delete" data-id="${i}">Excluir</button></div>`;
        listEl.appendChild(card);
      });
      listEl.querySelectorAll('.btn-edit').forEach(btn=>btn.onclick=()=>openEditModal(btn.dataset.id));
      listEl.querySelectorAll('.btn-delete').forEach(btn=>btn.onclick=()=>deleteCred(btn.dataset.id));
    }
    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    document.getElementById('btn-add').onclick = ()=>openEditModal();
    function openEditModal(idx){
      const modal = document.getElementById('modal-form');
      modal.classList.remove('hidden');
      const form = document.getElementById('credential-form');
      if (idx!==undefined){
        const c = credentials[idx];
        form['credential-id'].value = idx;
        form['service_name'].value = c.service_name;
        form['username'].value = c.username;
        form['password'].value = c.password;
        form['notes'].value = c.notes;
        document.getElementById('modal-title').innerText = 'Editar Senha';
      } else {
        form.reset();
        form['credential-id'].value = '';
        document.getElementById('modal-title').innerText = 'Nova Senha';
      }
    }
    document.getElementById('btn-cancel').onclick = ()=>document.getElementById('modal-form').classList.add('hidden');
    document.getElementById('credential-form').onsubmit = function(e){
      e.preventDefault();
      const idx = this['credential-id'].value;
      const cred = {
        service_name: this['service_name'].value,
        username: this['username'].value,
        password: this['password'].value,
        notes: this['notes'].value
      };
      if (idx) credentials[idx]=cred; else credentials.push(cred);
      localStorage.setItem('margarida_credentials', JSON.stringify(credentials));
      document.getElementById('modal-form').classList.add('hidden');
      renderCredentials();
    };
    function deleteCred(idx){
      if (!confirm('Excluir credencial?')) return;
      credentials.splice(idx,1);
      localStorage.setItem('margarida_credentials', JSON.stringify(credentials));
      renderCredentials();
    }

    // --- Treasury (Finanças) ---
    let expenses = JSON.parse(localStorage.getItem('margarida_expenses')||'[]');
    let incomes = JSON.parse(localStorage.getItem('margarida_incomes')||'[]');
    function renderExpenses(){
      const el = document.getElementById('expenses-list');
      el.innerHTML = '';
      if (!expenses.length){el.innerHTML='<div class="item-card">Nenhuma despesa</div>';return;}
      expenses.forEach((e,i)=>{
        el.innerHTML += `<div class="item-card"><div><strong>${escapeHtml(e.name)}</strong><div style="color:#666">${new Date(e.date).toLocaleDateString()}</div></div><div style="text-align:right"><div class="item-value">R$ ${Number(e.value).toFixed(2)}</div><div style="margin-top:8px"><button onclick="deleteExpense(${i})">Excluir</button></div></div></div>`;
      });
    }
    function renderIncomes(){
      const el = document.getElementById('incomes-list');
      el.innerHTML = '';
      if (!incomes.length){el.innerHTML='<div class="item-card">Nenhuma receita</div>';return;}
      incomes.forEach((i,idx)=>{
        el.innerHTML += `<div class="item-card"><div><strong>${escapeHtml(i.name)}</strong><div style="color:#666">${new Date(i.date).toLocaleDateString()}</div></div><div style="text-align:right"><div class="item-value" style="color:var(--flower-yellow)">R$ ${Number(i.value).toFixed(2)}</div><div style="margin-top:8px"><button onclick="deleteIncome(${idx})">Excluir</button></div></div></div>`;
      });
    }
    window.saveExpense = function(){
      const name=document.getElementById('expense-name').value.trim();
      const value=parseFloat(document.getElementById('expense-value').value);
      const date=document.getElementById('expense-date').value || new Date().toISOString();
      const method=document.getElementById('expense-method').value;
      if(!name||!value||value<=0){alert('Preencha campos');return}
      expenses.push({id:Date.now(),name,value,date:new Date(date).toISOString(),method,notes:''});
      localStorage.setItem('margarida_expenses', JSON.stringify(expenses));
      renderExpenses(); loadAnalytics();
    };
    window.saveIncome = function(){
      const name=document.getElementById('income-name').value.trim();
      const value=parseFloat(document.getElementById('income-value').value);
      const date=document.getElementById('income-date').value || new Date().toISOString();
      if(!name||!value||value<=0){alert('Preencha campos');return}
      incomes.push({id:Date.now(),name,value,date:new Date(date).toISOString(),notes:''});
      localStorage.setItem('margarida_incomes', JSON.stringify(incomes));
      renderIncomes(); loadAnalytics();
    };
    window.deleteExpense = function(idx){ if(!confirm('Excluir despesa?'))return; expenses.splice(idx,1); localStorage.setItem('margarida_expenses', JSON.stringify(expenses)); renderExpenses(); loadAnalytics(); };
    window.deleteIncome = function(idx){ if(!confirm('Excluir receita?'))return; incomes.splice(idx,1); localStorage.setItem('margarida_incomes', JSON.stringify(incomes)); renderIncomes(); loadAnalytics(); };

    // --- Analytics ---
    function loadAnalytics(){
      const now = new Date();
      let from = new Date(); from.setMonth(now.getMonth()-5); from.setDate(1); from.setHours(0,0,0,0);
      const expenses_total = expenses.filter(e=>new Date(e.date)>=from).reduce((s,e)=>s+Number(e.value||0),0);
      const incomes_total = incomes.filter(i=>new Date(i.date)>=from).reduce((s,i)=>s+Number(i.value||0),0);
      const balance = incomes_total - expenses_total;
      document.getElementById('expenses-total').textContent = 'R$ '+expenses_total.toFixed(2);
      document.getElementById('incomes-total').textContent = 'R$ '+incomes_total.toFixed(2);
      document.getElementById('balance-total').textContent = 'R$ '+balance.toFixed(2);
      document.getElementById('balance-total').style.color = balance<0? '#ff6b6b' : 'var(--flower-pink)';
      loadMethodChart(); loadMonthlyChart();
    }
    let methodChart=null; let monthlyChart=null;
    function aggregateByMethod(){
      const now=new Date(); let from=new Date(); from.setMonth(now.getMonth()-5); from.setDate(1); from.setHours(0,0,0,0);
      const methods = {}; expenses.filter(e=>new Date(e.date)>=from).forEach(e=>{methods[e.method]=(methods[e.method]||0)+Number(e.value||0)}); return methods;
    }
    function loadMethodChart(){
      const data = aggregateByMethod(); if (!data || Object.keys(data).length===0){ if (methodChart){ methodChart.destroy(); methodChart=null;} return; }
      const labels = Object.keys(data).map(m=>methodLabel(m)); const values = Object.values(data);
      const ctx = document.getElementById('methodChart'); if (methodChart) methodChart.destroy();
      methodChart = new Chart(ctx, {
        type:'doughnut', data:{ labels, datasets:[{data:values, backgroundColor:['#ff54a9','#FFD700','#9966CC','#fd6b36','#5FDD4D','#fd0389'],borderColor:'#fff',borderWidth:2 }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{size:16,weight:'bold'}, padding:20,usePointStyle:true, pointStyle:'circle' } }, tooltip:{ callbacks:{ label:function(ctx){ return ctx.label+': R$ '+ctx.parsed.toFixed(2); } } } } }
      });
    }
    function methodLabel(m){ const labels={'card':'Cartão','cash':'Dinheiro','transfer':'Transferência','debit':'Débito','pix':'Pix','bill':'Boleto'}; return labels[m]||m; }
    function loadMonthlyChart(){
      const allMonths = {}; const now = new Date(); let start = new Date(); start.setMonth(now.getMonth()-11); start.setDate(1);
      for (let m=0;m<12;m++){ const d = new Date(start.getFullYear(), start.getMonth()+m, 1); const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; allMonths[key]={expenses:0,incomes:0}; }
      expenses.forEach(e=>{ const d=new Date(e.date); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if (allMonths[key]) allMonths[key].expenses+=Number(e.value||0); });
      incomes.forEach(i=>{ const d=new Date(i.date); const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if (allMonths[key]) allMonths[key].incomes+=Number(i.value||0); });
      const months = Object.keys(allMonths).slice(-12);
      const expensesArr = months.map(m=>allMonths[m].expenses); const incomesArr = months.map(m=>allMonths[m].incomes);
      const labels = months.map(m=>{ const [y,mm]=m.split('-'); return new Date(y,mm-1).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}); });
      const ctx = document.getElementById('monthlyChart'); if (monthlyChart) monthlyChart.destroy();
      monthlyChart = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{label:'Despesas', data:expensesArr, backgroundColor:'#ff54a9'},{label:'Receitas', data:incomesArr, backgroundColor:'#FFD700'}]}, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>'R$ '+v.toLocaleString('pt-BR') } } }, plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>ctx.dataset.label+': R$ '+(ctx.parsed.y||ctx.parsed).toFixed(2) } } } } });
    }

    // --- Inicialização ---
    spaGo('login');
    renderCredentials();
    renderExpenses();
    renderIncomes();
    loadAnalytics();
    document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
  </script>
</body>
</html>
